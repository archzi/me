<!DOCTYPE html><html lang="zh-cmn-Hans" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-proxy-endpoint" content=""><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="后端研发日志记录规范" /><meta name="author" content="archzi" /><meta property="og:locale" content="zh_cmn_Hans" /><meta name="description" content="背景" /><meta property="og:description" content="背景" /><link rel="canonical" href="https://archzi.github.io/me/posts/log-conduct/" /><meta property="og:url" content="https://archzi.github.io/me/posts/log-conduct/" /><meta property="og:site_name" content="HeX" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-02T01:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="后端研发日志记录规范" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"archzi"},"description":"背景","url":"https://archzi.github.io/me/posts/log-conduct/","@type":"BlogPosting","headline":"后端研发日志记录规范","dateModified":"2020-07-02T01:00:00+08:00","datePublished":"2020-07-02T01:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://archzi.github.io/me/posts/log-conduct/"},"@context":"https://schema.org"}</script><title>后端研发日志记录规范 | HeX</title><link rel="apple-touch-icon" sizes="180x180" href="/me/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/me/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/me/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/me/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/me/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="HeX"><meta name="application-name" content="HeX"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/me/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/me/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script async src="/me/assets/js/dist/pvreport.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/me/assets/js/dist/post.min.js"></script> <script defer src="/me/app.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/me/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/19209941?s=400&u=e413893b42366b6cb405d3668217c262663bf0b5&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/me/">HeX</a></div><div class="site-subtitle font-italic">Happy coding, Happy living!</div></div><ul class="w-100"><li class="nav-item"> <a href="/me/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/me/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/me/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/me/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/me/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/archzi" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['archzi','qq.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/me/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/me/"> Posts </a> </span> <span>后端研发日志记录规范</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>后端研发日志记录规范</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> archzi </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Jul 2, 2020, 1:00 AM +0800" prep="on" > Jul 2, 2020 <i class="unloaded">2020-07-02T01:00:00+08:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1861 words">10 min</span> <span id="pv" class="pageviews"><i class="fas fa-spinner fa-spin fa-fw"></i></span></div></div><div class="post-content"><h2 id="背景">背景</h2><blockquote><p>日志：记录程序的运行轨迹，方便查找关键信息，也方便快速定位解决问题。</p></blockquote><p>随着公司发展，后端项目app的数量 越来越多，排查问题的复杂度越来越高，需要对日志的格式统一规划，便于后续日志收集分析报警。</p><h2 id="日志的作用why">日志的作用（WHY）</h2><ul><li><strong>问题追踪：</strong> 辅助排查和定位线上问题，优化程序运行性能。<li><strong>状态监控：</strong> 通过日志分析，可以监控系统的运行状态。<li><strong>安全审计：</strong> 审计主要体现在安全上，可以发现非授权的操作。</ul><h2 id="技术选型">技术选型</h2><p>经过调研，公司目前所有后端java 应用都是spring-boot 技术栈，而spring-boot的底层日志依赖关系如下图所示： <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/me/assets/img/post/2019110810594598.png" alt="图片" /></p><p>且，<code class="language-plaintext highlighter-rouge">logback</code>是 <code class="language-plaintext highlighter-rouge">slf4j</code>的默认实现，性能比<code class="language-plaintext highlighter-rouge">log4j</code>好很多,所以</p><ol><li>后端统一选择用<code class="language-plaintext highlighter-rouge">logback</code>作为日志记录依赖。<li>使用 <code class="language-plaintext highlighter-rouge">lombok</code> 插件增强添加 <code class="language-plaintext highlighter-rouge">log</code> 变量</ol><h2 id="记录规范-how">记录规范 (HOW)</h2><h3 id="记录时机">记录时机</h3><p>当符合以下情况时，需要选择合适的级别记录日志：</p><ol><li>无法处理的 <code class="language-plaintext highlighter-rouge">RuntimeException</code>,结合实际情况选择 warn 级别或 error级别<li>执行流程不符合业务流程，比如：参数不正确，类型不正确和返回值不在预期范围内等。选择 Error 或 info 级别<li>系统关键角色，组件核心动作： 比如服务之间的交互，数据库增删改等需要记录 info级别日志。<li>常规初始化： 系统初始化的关键参数等，需要记录info级别日志。</ol><h3 id="如何记录格式规范">如何记录（格式规范）</h3><p>结合公司实际情况，日志记录应包含以下信息：</p><ol><li>日志时间（精确到毫秒）<li>日志级别<li>应用名称 - 项目名称<li>调用链标识（可选）- 唯一字段<li>业务标识<li>线程名称<li>记录器名称（class名方法名）<li>日志消息<li>异常栈（可选）</ol><h3 id="日志文件名规范">日志文件名规范</h3><p>当前正在写入的日志文件名：<code class="language-plaintext highlighter-rouge">&lt;log-level&gt;.log</code></p><p>已经滚入历史的日志文件名：<code class="language-plaintext highlighter-rouge">&lt;log_level&gt;.log.&lt;yyyy-MM-dd&gt;</code></p><h3 id="禁止项">禁止项</h3><ol><li>禁止使用 System.out/error 记录<li>禁止出现 e.printStackTrace()<li>禁止线上环境 出现 debug 日志<li>禁止循环中打印日志</ol><h2 id="日志配置文件和工具">日志配置文件和工具</h2><h3 id="配置文件">配置文件</h3><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
</pre><td class="rouge-code"><pre>
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;configuration</span> <span class="na">scan=</span><span class="s">"true"</span> <span class="na">scanPeriod=</span><span class="s">"60 seconds"</span> <span class="na">debug=</span><span class="s">"false"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--读取spring 配置--&gt;</span>
    <span class="nt">&lt;springProperty</span> <span class="na">scope=</span><span class="s">"context"</span> <span class="na">name=</span><span class="s">"logPath"</span> <span class="na">source=</span><span class="s">"logging.file.path"</span> <span class="na">defaultValue=</span><span class="s">"logs"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;springProperty</span> <span class="na">scope=</span><span class="s">"context"</span> <span class="na">name=</span><span class="s">"appName"</span> <span class="na">source=</span><span class="s">"spring.application.name"</span> <span class="na">defaultValue=</span><span class="s">"ZL-PROJECT"</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!--定义日志文件的存储地址 勿在 LogBack 的配置中使用相对路径--&gt;</span>

    <span class="c">&lt;!--配置--&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"appName"</span> <span class="na">value=</span><span class="s">"${appName}"</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!--系统环境变量配置--&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"log.outside.level"</span> <span class="na">value=</span><span class="s">"DEBUG"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"CONSOLE_LOG_PATTERN"</span>
              <span class="na">value=</span><span class="s">"%d{yyyy-MM-dd HH:mm:ss.SSS} [%contextName][bizId:%X{bizId}][%thread] %-5level %logger{50} [trackId:%X{trackId}] - %msg%n"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;contextName&gt;</span>${appName}<span class="nt">&lt;/contextName&gt;</span>
    <span class="c">&lt;!-- 控制台输出 --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"STDOUT"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.ConsoleAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>${CONSOLE_LOG_PATTERN}
            <span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>
    <span class="c">&lt;!-- 按照每天生成日志文件 --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"ERROR"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;file&gt;</span>
            ${logPath}/error.log
        <span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--日志文件输出的文件名--&gt;</span>
            <span class="nt">&lt;FileNamePattern&gt;</span>${logPath}/bak/error.log.%d{yyyy-MM-dd}<span class="nt">&lt;/FileNamePattern&gt;</span>
            <span class="c">&lt;!--日志文件保留天数--&gt;</span>
            <span class="nt">&lt;MaxHistory&gt;</span>30<span class="nt">&lt;/MaxHistory&gt;</span>
        <span class="nt">&lt;/rollingPolicy&gt;</span>
        <span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>${CONSOLE_LOG_PATTERN}-%caller{2}<span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
        <span class="c">&lt;!--日志文件最大的大小--&gt;</span>
        <span class="nt">&lt;triggeringPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;MaxFileSize&gt;</span>100MB<span class="nt">&lt;/MaxFileSize&gt;</span>
        <span class="nt">&lt;/triggeringPolicy&gt;</span>
        <span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.filter.LevelFilter"</span><span class="nt">&gt;</span><span class="c">&lt;!-- 只打印错误日志 --&gt;</span>
            <span class="nt">&lt;level&gt;</span>ERROR<span class="nt">&lt;/level&gt;</span>
            <span class="nt">&lt;onMatch&gt;</span>ACCEPT<span class="nt">&lt;/onMatch&gt;</span>
            <span class="nt">&lt;onMismatch&gt;</span>DENY<span class="nt">&lt;/onMismatch&gt;</span>
        <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>

    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"INFO"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;file&gt;</span>${logPath}/info.log<span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--日志文件输出的文件名--&gt;</span>
            <span class="nt">&lt;FileNamePattern&gt;</span>${logPath}/bak/info.log.%d{yyyy-MM-dd}<span class="nt">&lt;/FileNamePattern&gt;</span>
            <span class="c">&lt;!--日志文件保留天数--&gt;</span>
            <span class="nt">&lt;MaxHistory&gt;</span>30<span class="nt">&lt;/MaxHistory&gt;</span>
        <span class="nt">&lt;/rollingPolicy&gt;</span>
        <span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>${CONSOLE_LOG_PATTERN}<span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
        <span class="c">&lt;!--日志文件最大的大小--&gt;</span>
        <span class="nt">&lt;triggeringPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;MaxFileSize&gt;</span>100MB<span class="nt">&lt;/MaxFileSize&gt;</span>
        <span class="nt">&lt;/triggeringPolicy&gt;</span>

        <span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.filter.LevelFilter"</span><span class="nt">&gt;</span><span class="c">&lt;!-- 只打印INFO日志 --&gt;</span>
            <span class="nt">&lt;level&gt;</span>INFO<span class="nt">&lt;/level&gt;</span>
            <span class="nt">&lt;onMatch&gt;</span>ACCEPT<span class="nt">&lt;/onMatch&gt;</span>
            <span class="nt">&lt;onMismatch&gt;</span>DENY<span class="nt">&lt;/onMismatch&gt;</span>
        <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>

    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"DEBUG"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;file&gt;</span>
            ${logPath}/debug.log
        <span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--日志文件输出的文件名--&gt;</span>
            <span class="nt">&lt;FileNamePattern&gt;</span>${logPath}/bak/debug.log.%d{yyyy-MM-dd}<span class="nt">&lt;/FileNamePattern&gt;</span>
            <span class="c">&lt;!--日志文件保留天数--&gt;</span>
            <span class="nt">&lt;MaxHistory&gt;</span>30<span class="nt">&lt;/MaxHistory&gt;</span>
        <span class="nt">&lt;/rollingPolicy&gt;</span>
        <span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>${CONSOLE_LOG_PATTERN}<span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
        <span class="c">&lt;!--日志文件最大的大小--&gt;</span>
        <span class="nt">&lt;triggeringPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;MaxFileSize&gt;</span>100MB<span class="nt">&lt;/MaxFileSize&gt;</span>
        <span class="nt">&lt;/triggeringPolicy&gt;</span>

        <span class="nt">&lt;filter</span> <span class="na">class=</span><span class="s">"ch.qos.logback.classic.filter.LevelFilter"</span><span class="nt">&gt;</span><span class="c">&lt;!-- 只打印DEBUG日志 --&gt;</span>
            <span class="nt">&lt;level&gt;</span>DEBUG<span class="nt">&lt;/level&gt;</span>
            <span class="nt">&lt;onMatch&gt;</span>ACCEPT<span class="nt">&lt;/onMatch&gt;</span>
            <span class="nt">&lt;onMismatch&gt;</span>DENY<span class="nt">&lt;/onMismatch&gt;</span>
        <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>


    <span class="c">&lt;!-- 测试环境+开发环境. 多个使用逗号隔开. --&gt;</span>
    <span class="nt">&lt;springProfile</span> <span class="na">name=</span><span class="s">"test"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"org.springframework.web"</span> <span class="na">level=</span><span class="s">"INFO"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.jizhang.platform"</span> <span class="na">level=</span><span class="s">"INFO"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.ibatis"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.ibatis.common.jdbc.SimpleDataSource"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.ibatis.common.jdbc.ScriptRunner"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.ibatis.sqlmap.engine.impl.SqlMapClientDelegate"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"java.sql.Connection"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"java.sql.Statement"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"java.sql.PreparedStatement"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.jizhang.platform.mapper"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/springProfile&gt;</span>

    <span class="c">&lt;!-- 生产环境. --&gt;</span>
    <span class="nt">&lt;springProfile</span> <span class="na">name=</span><span class="s">"prod"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"org.springframework.web"</span> <span class="na">level=</span><span class="s">"ERROR"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.jizhang.platform"</span> <span class="na">level=</span><span class="s">"INFO"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.ibatis"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.ibatis.common.jdbc.SimpleDataSource"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.ibatis.common.jdbc.ScriptRunner"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.ibatis.sqlmap.engine.impl.SqlMapClientDelegate"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"java.sql.Connection"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"java.sql.Statement"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"java.sql.PreparedStatement"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"com.jizhang.platform.mapper"</span> <span class="na">level=</span><span class="s">"${log.outside.level}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/springProfile&gt;</span>

    <span class="c">&lt;!-- 日志输出级别 --&gt;</span>
    <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">"INFO"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"STDOUT"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"ERROR"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"INFO"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"DEBUG"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/root&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>

</pre></table></code></div></div><h3 id="配置文件使用">配置文件使用</h3><ol><li>将上述中的 logback-spring.xml 中的内容复制到项目 Resource 目录下，命名为： logback-spring.xml<li>在 spring properties中指定以下配置<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>logging.config=classpath:logback-spring.xml
</pre></table></code></div></div><li>在 spring properties 配置文件中指定log 文件输出目录(绝对地址),默认为项目 jar包 执行目录，示例如下<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>logging.file.path=/var/log/{appName}
</pre></table></code></div></div><li><p>配置 appName<br /> 在spring property 文件中指定<code class="language-plaintext highlighter-rouge">spring.application.name</code> 属性，logback 配置文件中配置了 <code class="language-plaintext highlighter-rouge">contextName</code>为 <code class="language-plaintext highlighter-rouge">spring.application.name</code></p><li>调用链表标识 在需要 输出 调用链标识的时候 配置时，使用 <code class="language-plaintext highlighter-rouge">org.slf4j.MDC</code>定义<code class="language-plaintext highlighter-rouge">trackId</code>字段，具体可参考下面代码<pre><code class="language-JAVA">MDC.put("trackId","trackId");
</code></pre><p>‘trackId’： 可以认为是方法调用过程中的唯一不变的字段，比如：userId,或者操作的字段id,或者接到的请求跟踪id 等</p><li>业务标识 需要输出 业务标识字段的时候，使用<code class="language-plaintext highlighter-rouge">MDC</code>配置 <code class="language-plaintext highlighter-rouge">bizId</code>字段。</ol><p><strong>注意</strong>： MDC 的实现是通过 <code class="language-plaintext highlighter-rouge">ThreadLocal&lt;Map&lt;String,String&gt;&gt;</code>实现的,具体可是查阅 ch.qos.logback.classic.util.LogbackMDCAdapter 源码，所以要注意 MDC中字段的更新问题，在多线程环境中尤其要注意线程中的任务执行完毕的时候记得 调用 MDC.clear()方法清理。</p><p>如上配置可达到以下效果</p><pre><code class="language-log">2020-06-01 15:34:19.630 [zl-platform][bizId:bizExample][main] INFO  com.jizhang.testlog.TestlogApplication [trackId:trackExample] - info message!!!
2020-06-01 15:34:19.630 [zl-platform][bizId:bizExample][main] ERROR com.jizhang.testlog.TestlogApplication [trackId:trackExample] - error message!!!!
2020-06-01 15:34:19.633 [zl-platform][bizId:bizExample][main] ERROR com.jizhang.testlog.TestlogApplication [trackId:trackExample] - java.lang.Exception: messages!!!,exception!
</code></pre><h2 id="参考">参考</h2><ul><li><a href="https://www.jianshu.com/p/546e9aace657">Java日志记录最佳实践</a><li><a href="https://mp.weixin.qq.com/s/c3dTTkbTNqnZTy_Da19I6Q">优秀日志实践准则</a></ul><h1 id="nginx-日志规范">Nginx 日志规范</h1><h2 id="日志格式">日志格式</h2><p>Nginx 日志格式统一为一下格式：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"'
                      'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time"';

</pre></table></code></div></div><p>以上格式在默认格式的基础上添加了反向代理的转发相关信息，供排查问题用。</p><h2 id="目录格式">目录格式</h2><p>Nginx 默认日志目录为 /var/log/nginx， 反向代理的服务目录 日志目录无需设置，在默认目录下会有相关文件夹。</p><h2 id="参考-1">参考</h2><ul><li><a href="https://docs.nginx.com/nginx/admin-guide/monitoring/logging/">Nginx 官方</a><li><a href="https://blog.qiniu.com/archives/8779">如何建设高吞吐量的日志平台</a><li><a href="https://sematext.com/blog//logstash-alternatives/">Logstash Alternatives</a></ul><h2 id="日志收集">日志收集</h2><p>考虑到目前日志主要用于 ES 分析，暂定方案为 fileBeats 收集各个系统的日志（包括nginx），统一汇总到logstash 平台然后过滤分析到 ES搜索/kibana分析</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/me/categories/%E7%AC%94%E8%AE%B0/'>笔记</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/me/tags/%E6%80%BB%E7%BB%93/" class="post-tag no-text-decoration" >总结</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=后端研发日志记录规范 - HeX&url=https://archzi.github.io/me/posts/log-conduct/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=后端研发日志记录规范 - HeX&u=https://archzi.github.io/me/posts/log-conduct/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=后端研发日志记录规范 - HeX&url=https://archzi.github.io/me/posts/log-conduct/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/me/posts/how-to-collect-log/">日志收集</a><li><a href="/me/posts/Start-with-Gradle/">Gradle 基础学习笔记</a><li><a href="/me/posts/CDH%E5%AE%89%E8%A3%85/">CDH 平台安装笔记</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/me/tags/%E7%AC%94%E8%AE%B0/">笔记</a> <a class="post-tag" href="/me/tags/%E6%80%BB%E7%BB%93/">总结</a> <a class="post-tag" href="/me/tags/%E6%8C%96%E5%9D%91/">挖坑</a> <a class="post-tag" href="/me/tags/%E5%A4%87%E4%BB%BD/">备份</a> <a class="post-tag" href="/me/tags/%E7%BF%BB%E8%AF%91%E5%AD%A6%E4%B9%A0/">翻译学习</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/me/posts/how-to-collect-log/"><div class="card-body"> <span class="timeago small" > Jul 2, 2020 <i class="unloaded">2020-07-02T01:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>日志收集</h3><div class="text-muted small"><p> logstash 缺点： 性能问题 具体 benchmark 可以参考链接 不支持缓存，典型的替代方案还得依赖 kafka 或者Redis 作为中心缓存池 Flume Flume基于流式数据的、使用简单的（借助配置文件即可）、健壮的、容错的。 Flume的简单体现在：写一个source、channel、sink之后，一条命令就...</p></div></div></a></div><div class="card"> <a href="/me/posts/Start-with-Gradle/"><div class="card-body"> <span class="timeago small" > Jun 2 <i class="unloaded">2021-06-02T01:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Gradle 基础学习笔记</h3><div class="text-muted small"><p> 介绍 gralde 是一个 开源的自动化构建工具，设计的初衷就是为了足够灵活，来满足几乎所有软件的构建需求。并且具有以下的功能： 高性能 只编译需要编译的部分（因为 task 的输入和输出变动），甚至可以在不同的机器上利用 build cache（有共享 cache 的条件下） 基于 JVM 熟悉java 的人很轻松就能学会 基于约定实现 gradle 借鉴了...</p></div></div></a></div><div class="card"> <a href="/me/posts/Java-Interface/"><div class="card-body"> <span class="timeago small" > Jun 2 <i class="unloaded">2021-06-02T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Java interface</h3><div class="text-muted small"><p></p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/me/posts/how-to-collect-log/" class="btn btn-outline-primary" prompt="Older"><p>日志收集</p></a> <a href="/me/posts/Java-Interface/" class="btn btn-outline-primary" prompt="Newer"><p>Java interface</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/me/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//https-bytesmithing-github-io.disqus.com/embed.js', disqusConfig: function() { this.page.title = '后端研发日志记录规范'; this.page.url = 'https://archzi.github.io/me/posts/log-conduct/'; this.page.identifier = '/posts/log-conduct/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/archzi">archzi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/me/tags/%E7%AC%94%E8%AE%B0/">笔记</a> <a class="post-tag" href="/me/tags/%E6%80%BB%E7%BB%93/">总结</a> <a class="post-tag" href="/me/tags/%E6%8C%96%E5%9D%91/">挖坑</a> <a class="post-tag" href="/me/tags/%E5%A4%87%E4%BB%BD/">备份</a> <a class="post-tag" href="/me/tags/%E7%BF%BB%E8%AF%91%E5%AD%A6%E4%B9%A0/">翻译学习</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/me/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://archzi.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
